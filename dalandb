CREATE DATABASE dalandb;
USE dalandb;

-- 1) USERS
CREATE TABLE users (
    user_id INT AUTO_INCREMENT PRIMARY KEY,
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    email VARCHAR(150) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    profile_picture_url VARCHAR(500),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 2) LOCATIONS
CREATE TABLE locations (
    location_id INT AUTO_INCREMENT PRIMARY KEY,
    province VARCHAR(100) DEFAULT 'Pangasinan',
    district VARCHAR(100) NOT NULL,
    city_municipality VARCHAR(150) NOT NULL
);

-- 3) INSTITUTION TYPE
CREATE TABLE institution_type (
    type_id INT AUTO_INCREMENT PRIMARY KEY,
    type_name VARCHAR(100) NOT NULL,
    description TEXT
);

-- 4) USER PROFILE PREFERRENCES SETUP
CREATE TABLE user_profile (
    profile_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    shs_strand VARCHAR(100),
    preferred_institution_type INT,
    location_id INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (preferred_institution_type) REFERENCES institution_type(type_id),
    FOREIGN KEY (location_id) REFERENCES locations(location_id)
);

-- 5) USER INTEREST PREFERRENCES SETUP
CREATE TABLE user_interests (
    interest_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    program_id INT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (program_id) REFERENCES programs(program_id) ON DELETE CASCADE
);

-- 6) UNIVERSITIES
CREATE TABLE universities (
    university_id INT AUTO_INCREMENT PRIMARY KEY,
    university_name VARCHAR(255) NOT NULL,
    abbreviation VARCHAR(50),
    type_id INT NOT NULL,
    location_id INT NOT NULL,
    short_description VARCHAR(500),
    long_description TEXT,
    logo_url VARCHAR(500),
    cover_photo_url VARCHAR(500),
    website VARCHAR(255),
    phone VARCHAR(50),
    email VARCHAR(150),
    acceptance_rate DECIMAL(5,2),
    tuition_range VARCHAR(100),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (type_id) REFERENCES institution_type(type_id),
    FOREIGN KEY (location_id) REFERENCES locations(location_id)
);

-- 7) PROGRAMS
CREATE TABLE programs (
    program_id INT AUTO_INCREMENT PRIMARY KEY,
    university_id INT NOT NULL,
    program_name VARCHAR(255) NOT NULL,
    abbreviation VARCHAR(50),             
    description TEXT,
    logo_url VARCHAR(500),                
    is_licensure_based BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (university_id) REFERENCES universities(university_id) ON DELETE CASCADE
);

-- 8) PROGRAM TUITION 
CREATE TABLE prog_tuition (
    tuition_id INT AUTO_INCREMENT PRIMARY KEY,
    program_id INT NOT NULL,
    amount_per_year DECIMAL(10,2) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (program_id) REFERENCES programs(program_id) ON DELETE CASCADE
);

-- 9) PROGRAM REQUIREMENTS
CREATE TABLE prog_req (
    req_id INT AUTO_INCREMENT PRIMARY KEY,
    program_id INT NOT NULL,
    requirement TEXT NOT NULL,

    FOREIGN KEY (program_id) REFERENCES programs(program_id) ON DELETE CASCADE
);

-- 10) PROGAM SCHOLARSHIP
CREATE TABLE prog_scholarship (
    scholarship_id INT AUTO_INCREMENT PRIMARY KEY,
    program_id INT NOT NULL,
    scholarship_name VARCHAR(255) NOT NULL,
    description TEXT,
    requirements TEXT,

    FOREIGN KEY (program_id) REFERENCES programs(program_id) ON DELETE CASCADE
);

-- 11) EXAM RESULTS
CREATE TABLE exam_results (
    exam_id INT AUTO_INCREMENT PRIMARY KEY,
    program_id INT NOT NULL,
    university_id INT NOT NULL,
    year YEAR NOT NULL,
    total_examinees INT,
    total_passers INT,
    first_timers_total INT,
    first_timers_passed INT,
    repeaters_total INT,
    repeaters_passed INT,
    number_of_topnotchers INT,

    FOREIGN KEY (program_id) REFERENCES programs(program_id),
    FOREIGN KEY (university_id) REFERENCES universities(university_id)
);

-- 12) BOOKMARK
CREATE TABLE bookmark (
    bookmark_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    program_id INT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (program_id) REFERENCES programs(program_id) ON DELETE CASCADE
);

-- 13) USER ACTIVITY
CREATE TABLE user_activity (
    activity_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    program_id INT,
    action_type VARCHAR(50),
    viewed_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (program_id) REFERENCES programs(program_id) ON DELETE SET NULL
);

-- 14) NOTIFICATIONS
CREATE TABLE notifications (
    notification_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    category VARCHAR(50),
    is_read BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

-- 15) RESET PASSWORD
CREATE TABLE password_reset (
    reset_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    token VARCHAR(255) NOT NULL,
    expires_at DATETIME NOT NULL,
    used BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

-- GRAPH 1: TOP PROGRAMS PER YEAR 
SELECT 
    p.program_id,

    CASE 
        WHEN p.abbreviation IS NOT NULL AND p.abbreviation <> '' 
        THEN CONCAT(p.abbreviation, ' — ', p.program_name)
        ELSE p.program_name
    END AS program_label,

    CASE 
        WHEN u.abbreviation IS NOT NULL AND u.abbreviation <> '' 
        THEN CONCAT(u.abbreviation, ' — ', u.university_name)
        ELSE u.university_name
    END AS university_label,

    er.passing_rate
FROM exam_results er
JOIN programs p ON er.program_id = p.program_id
JOIN universities u ON er.university_id = u.university_id
WHERE er.year = :selectedYear
ORDER BY er.passing_rate DESC
LIMIT 5;

-- GRAPH 2: TOP UNIVERSITIES PER YEAR 
SELECT
    u.university_id,

    CASE 
        WHEN u.abbreviation IS NOT NULL AND u.abbreviation <> '' 
        THEN CONCAT(u.abbreviation, ' — ', u.university_name)
        ELSE u.university_name
    END AS university_label,

    SUM(er.total_passers) / SUM(er.total_examinees) * 100 AS university_passing_rate
FROM exam_results er
JOIN universities u ON er.university_id = u.university_id
WHERE er.year = :selectedYear
GROUP BY u.university_id
ORDER BY university_passing_rate DESC
LIMIT 5;

-- TABLE: PROGRAM DETAILS COMPARISON
SELECT
    p.program_id,

    CASE 
        WHEN p.abbreviation IS NOT NULL AND p.abbreviation <> '' 
            THEN CONCAT(p.abbreviation, ' — ', p.program_name)
        ELSE p.program_name
    END AS program_label,

    CASE 
        WHEN u.abbreviation IS NOT NULL AND u.abbreviation <> '' 
            THEN CONCAT(u.abbreviation, ' — ', u.university_name)
        ELSE u.university_name
    END AS university_label,

    it.type_name AS institution_type,
    CONCAT(l.city_municipality, ', ', l.district) AS location,

    pt.amount_per_year AS tuition,

    
    SUM(er.total_passers) / SUM(er.total_examinees) * 100 AS total_rate,
    SUM(er.first_timers_passed) / SUM(er.first_timers_total) * 100 AS first_time_rate,
    SUM(er.repeaters_passed) / SUM(er.repeaters_total) * 100 AS repeater_rate,

    
    SUM(er.total_examinees) AS total_examinees,
    SUM(er.first_timers_total) AS first_time_examinees,
    SUM(er.repeaters_total) AS repeater_examinees,

    
    SUM(er.number_of_topnotchers) AS total_topnotchers   

FROM programs p
JOIN universities u ON p.university_id = u.university_id
JOIN institution_type it ON u.type_id = it.type_id
JOIN locations l ON u.location_id = l.location_id
LEFT JOIN prog_tuition pt ON p.program_id = pt.program_id
LEFT JOIN exam_results er ON p.program_id = er.program_id

WHERE p.program_id = :programId
GROUP BY p.program_id;
